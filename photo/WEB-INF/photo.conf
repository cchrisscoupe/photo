# DB stuff
dbDriverName org.postgresql.Driver
dbSource jdbc:postgresql://db/photo
dbPoolName photo_db
dbUser nobody
dbPass nopassword
# Two hours
dbMaxLifeTime 7200000
dbMinConns 0
dbMaxConns 5

# dbDriverName javax.sql.DataSource
# dbPoolType jndi
# dbSource java:comp/env/jdbc/photo
# dbUser notused
# dbPass notused

objectserver //tramp/RObjectServer
imageserver //tramp/ImageServer
# objectserver //disk/RObjectServer
# imageserver //disk/ImageServer
includes /afs/spy.net/home/dustin/public_html/jphoto/inc/

# Thumbnail size
thumbnail_size 220x146

# Stylesheets to choose from
xslt.default /afs/spy.net/home/dustin/public_html/jphoto/inc/xsl/default.xsl
xslt.simple  /afs/spy.net/home/dustin/public_html/jphoto/inc/xsl/simple.xsl
xslt.method  http://www.method.cx/~method/stylesheets/default.xsl

# for debug
xslt_cache_timeout 60
xml_cache_timeout 60

timezone GMT
cryptohash SHA

storer_sleep 10

# Reports!

# Most popular searches
report.repmostpopular.sql= \
	select photo_logs.photo_id, album.keywords, cat.name as catname, count(*) \
		from photo_logs, album, cat, log_types \
		where photo_logs.photo_id=album.id \
			and album.cat=cat.id \
			and log_types.log_type_id=photo_logs.log_type \
			and log_types.log_type = 'ImgView' \
		group by photo_id, keywords, catname \
		order by count desc \
		limit 50

report.repmostpopular.top=reports/mostpopular.top.inc
report.repmostpopular.row=reports/mostpopular.row.inc
report.repmostpopular.bottom=reports/mostpopular.bottom.inc


# most popular in the last 30 days
report.repmostpopular30d.sql=\
	select photo_logs.photo_id, album.keywords, cat.name as catname, count(*) \
		from photo_logs, album, cat, log_types \
		where photo_logs.photo_id=album.id \
			and album.cat = cat.id \
			and photo_logs.ts > 'now'::datetime-'30 days'::timespan \
			and log_types.log_type_id=photo_logs.log_type \
			and log_types.log_type = 'ImgView' \
		group by photo_id, keywords, catname \
		order by count desc \
		limit 50

report.repmostpopular30d.top=reports/mostpopular.top.inc
report.repmostpopular30d.row=reports/mostpopular.row.inc
report.repmostpopular30d.bottom=reports/mostpopular.bottom.inc

# Most common remote IP addresses
report.repmostcommonip.sql=\
	select photo_logs.remote_addr, count(*) \
		from photo_logs, log_types \
		where \
			log_types.log_type_id=photo_logs.log_type \
			and log_types.log_type = 'ImgView' \
		group by remote_addr \
		order by count desc \
		limit 50
report.repmostcommonip.top=reports/commonip.top.inc
report.repmostcommonip.row=reports/commonip.row.inc
report.repmostcommonip.bottom=reports/commonip.bottom.inc

# Logins
report.repauth.sql=\
	select * from auth_log_view \
		limit 50
report.repauth.top=reports/auth.top.inc
report.repauth.row=reports/auth.row.inc
report.repauth.bottom=reports/auth.bottom.inc

# Logs
report.replogs.sql=\
	select \
		u.username, l.photo_id, l.remote_addr, l.extra_info, t.log_type, l.ts \
	from \
		photo_logs l, wwwusers u, log_types t \
	where \
		u.id=l.wwwuser_id \
		and l.log_type=t.log_type_id \
		and l.ts > now() - '7 days'::timespan \
	order by \
		l.ts desc \
	limit 50
report.replogs.top=reports/logs.top.inc
report.replogs.row=reports/logs.row.inc
report.replogs.bottom=reports/logs.bottom.inc

report.repratebymonth.sql=\
	select date(date_trunc('month', l.ts)) as month, count(*) as views \
		from \
			photo_logs l inner join log_types t on (l.log_type=t.log_type_id) \
		where \
			t.log_type='ImgView' \
		group by \
			month \
		order by \
			month desc
report.repratebymonth.top=reports/rates.top.inc
report.repratebymonth.row=reports/rates.row.inc
report.repratebymonth.bottom=reports/rates.bottom.inc

report.repupratebymonth.sql=\
	select date(date_trunc('month', l.ts)) as month, count(*) as views \
		from \
			photo_logs l inner join log_types t on (l.log_type=t.log_type_id) \
		where \
			t.log_type='Upload' \
		group by \
			month \
		order by \
			month desc
report.repupratebymonth.top=reports/uprates.top.inc
report.repupratebymonth.row=reports/rates.row.inc
report.repupratebymonth.bottom=reports/rates.bottom.inc

report.repuserview.sql=\
	select \
		u.username, count(*) as views \
	from \
		wwwusers u, \
		photo_logs l, \
		log_types t \
	where \
		u.id=l.wwwuser_id \
		and l.log_type=t.log_type_id \
		and t.log_type='ImgView' \
	group by \
		username \
	order by \
		views desc
report.repuserview.top=reports/repuserview.top.inc
report.repuserview.row=reports/repuserview.row.inc
report.repuserview.bottom=reports/repuserview.bottom.inc

report.repjason.mostpopular.sql= \
	select photo_logs.photo_id, album.keywords, cat.name as catname, count(*) \
		from photo_logs, album, cat, log_types \
		where photo_logs.photo_id=album.id \
			and cat.name LIKE 'Jason%' \
			and album.cat=cat.id \
			and log_types.log_type_id=photo_logs.log_type \
			and log_types.log_type = 'ImgView' \
		group by photo_id, keywords, catname \
		order by count desc \
		limit 50
report.repjason.mostpopular.top=reports/mostpopular.top.inc
report.repjason.mostpopular.row=reports/mostpopular.row.inc
report.repjason.mostpopular.bottom=reports/mostpopular.bottom.inc

report.repjason.mostpopular30d.sql= \
	select photo_logs.photo_id, album.keywords, cat.name as catname, count(*) \
		from photo_logs, album, cat, log_types \
		where photo_logs.photo_id=album.id \
			and cat.name LIKE 'Jason%' \
			and album.cat = cat.id \
			and photo_logs.ts > 'now'::datetime-'30 days'::timespan \
			and log_types.log_type_id=photo_logs.log_type \
			and log_types.log_type = 'ImgView' \
		group by photo_id, keywords, catname \
		order by count desc \
		limit 50
report.repjason.mostpopular30d.top=reports/mostpopular.top.inc
report.repjason.mostpopular30d.row=reports/mostpopular.row.inc
report.repjason.mostpopular30d.bottom=reports/mostpopular.bottom.inc
